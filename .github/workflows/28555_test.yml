name: TestCppCode

# doloca kdaj se workflow sprozi
on:
  push:
    branches: [master]
  workflow_dispatch: 

jobs:
# runs on self hosted
  check_tests:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

        # Izpis vseh C++ datotek v repozitoriju 
      - name: List directory contents
        run: find . -type f -name "*.cpp" | sort

        # Preveri ali obstajajo
      - name: Check if tests exist
        run: |
          if [ ! -f "binaryradix/binaryradix_test.cpp" ]; then
            echo "Error: binaryradix_test.cpp doesn't exist" >&2
            exit 1
          fi
          
          if [ ! -f "binaryradix/binaryradix.cpp" ]; then
            echo "Error: binaryradix.cpp doesn't exist" >&2
            exit 1
          fi
        continue-on-error: true

      # preusmeri napake
      - name: Redirect stderr to file
        run: ls -la binaryradix/binaryradix_test.cpp 2> napaka.txt || true
      
      - name: Upload error file as artifact
        uses: actions/upload-artifact@v4
        with:
          name: error-log
          path: napaka.txt

         # Naloži datoteko z napakami kot artefakt za uporabo v naslednjem poslu
      - name: Check test status and create status artifact
        run: |
          if [ -s napaka.txt ]; then
            echo "FAILED" > test_status.txt
          else
            echo "PASSED" > test_status.txt
          fi

        # Naloži statusno datoteko kot artefakt za uporabo v naslednjem poslu
      - name: Upload test status as artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-status
          path: test_status.txt


  # Drugi posel - izvajanje testov, če so potrebne datoteke prisotne
  run-tests:
    needs: check_tests
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

        # Prenesi datoteko z napakami iz prejšnjega posla
      - name: Download errorlog
        uses: actions/download-artifact@v4
        with:
          name: error-log
      
      - name: Download test status
        uses: actions/download-artifact@v4
        with:
          name: test-status

      # Preveri status iz prejšnjega posla in prekini, če so bile najdene napake
      - name: Check for errors in previous job
        run: |
          if [ "$(cat test_status.txt)" == "FAILED" ]; then
            echo "Errors found in previous job:"
            cat napaka.txt
            exit 1
          fi
      
      - name: Build tests
        run: |
          cd binaryradix
          g++ -o run_tests binaryradix_test.cpp binaryradix.cpp -lgtest -lgtest_main -pthread
      
      - name: Run tests
        run: |
          cd binaryradix
          ./run_tests
          
      - name: Create test results artifact
        run: |
          echo "Tests passed successfully!" > test_results.txt
          
      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test_results.txt
